name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-test:
    name: Backend Python Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Check Python Code Syntax
      run: |
        python -m py_compile app.py
        find . -name "*.py" -not -path "./web/*" -not -path "./.git/*" -not -path "./__pycache__/*" -exec python -m py_compile {} \;
    
    - name: Validate API Server
      run: |
        python -c "from api.server import app; print('API server imports successfully')"
    
    - name: Verify Requirements
      run: |
        python -c "import flask, flask_cors, requests, dns.resolver, bs4, gunicorn; print('All dependencies available')"

  frontend-build:
    name: Frontend Build & Type Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest
    
    - name: Install dependencies
      working-directory: web
      run: bun install --frozen-lockfile
    
    - name: TypeScript Type Check
      working-directory: web
      run: bun run tsc --noEmit
    
    - name: Build Production Bundle
      working-directory: web
      run: bun run build
      env:
        NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:3030' }}

  deployment-readiness:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-build]
    steps:
    - uses: actions/checkout@v4
    
    - name: Verify Required Files
      run: |
        echo "Checking deployment files..."
        test -f requirements.txt && echo "✓ requirements.txt"
        test -f api/server.py && echo "✓ api/server.py"
        test -f web/package.json && echo "✓ package.json"
        test -f web/src/lib/api.ts && echo "✓ api.ts"
        test -f web/src/lib/utils.ts && echo "✓ utils.ts"
        test -f web/tsconfig.json && echo "✓ tsconfig.json"
        echo "All deployment files present"